import React, { useState, useRef, useEffect } from 'react';
import { Plus, Trash2, Play, RotateCcw, Upload, Download, Users, Edit2, Check, X } from 'lucide-react';

export default function WheelPicker() {
  const [classes, setClasses] = useState([]);
  const [currentClassId, setCurrentClassId] = useState(null);
  const [items, setItems] = useState([]);
  const [removedItems, setRemovedItems] = useState([]);
  const [newItem, setNewItem] = useState('');
  const [rotation, setRotation] = useState(0);
  const [isSpinning, setIsSpinning] = useState(false);
  const [winner, setWinner] = useState('');
  const [isLoading, setIsLoading] = useState(true);
  const [newClassName, setNewClassName] = useState('');
  const [isAddingClass, setIsAddingClass] = useState(false);
  const [editingClassId, setEditingClassId] = useState(null);
  const [editingClassName, setEditingClassName] = useState('');
  const wheelRef = useRef(null);
  const fileInputRef = useRef(null);
  const allClassesFileInputRef = useRef(null);

  const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'];

  useEffect(() => {
    loadData();
  }, []);

  useEffect(() => {
    if (!isLoading && currentClassId) {
      saveCurrentClass();
    }
  }, [items, removedItems]);

  useEffect(() => {
    if (!isLoading) {
      saveClassesList();
    }
  }, [classes]);

  const loadData = async () => {
    try {
      const classesResult = await window.storage.get('wheel-classes');
      const currentClassResult = await window.storage.get('wheel-current-class');
      
      let loadedClasses = [];
      if (classesResult && classesResult.value) {
        loadedClasses = JSON.parse(classesResult.value);
      }
      
      if (loadedClasses.length === 0) {
        const defaultClass = {
          id: Date.now().toString(),
          name: 'Ma classe',
          items: ['Alice', 'Bob', 'Charlie', 'Diana', 'Emma', 'Frank'],
          removedItems: []
        };
        loadedClasses = [defaultClass];
      }
      
      setClasses(loadedClasses);
      
      let classIdToLoad = null;
      if (currentClassResult && currentClassResult.value) {
        classIdToLoad = currentClassResult.value;
      } else {
        classIdToLoad = loadedClasses[0].id;
      }
      
      const classToLoad = loadedClasses.find(c => c.id === classIdToLoad) || loadedClasses[0];
      setCurrentClassId(classToLoad.id);
      setItems(classToLoad.items || []);
      setRemovedItems(classToLoad.removedItems || []);
      
    } catch (error) {
      console.log('Premi√®re utilisation');
      const defaultClass = {
        id: Date.now().toString(),
        name: 'Ma classe',
        items: ['Alice', 'Bob', 'Charlie', 'Diana', 'Emma', 'Frank'],
        removedItems: []
      };
      setClasses([defaultClass]);
      setCurrentClassId(defaultClass.id);
      setItems(defaultClass.items);
      setRemovedItems(defaultClass.removedItems);
    } finally {
      setIsLoading(false);
    }
  };

  const saveCurrentClass = async () => {
    const updatedClasses = classes.map(c => 
      c.id === currentClassId 
        ? { ...c, items, removedItems }
        : c
    );
    setClasses(updatedClasses);
  };

  const saveClassesList = async () => {
    try {
      await window.storage.set('wheel-classes', JSON.stringify(classes));
    } catch (error) {
      console.error('Erreur de sauvegarde des classes:', error);
    }
  };

  const switchClass = async (classId) => {
    if (classId === currentClassId) return;
    
    const classToLoad = classes.find(c => c.id === classId);
    if (classToLoad) {
      setCurrentClassId(classId);
      setItems(classToLoad.items || []);
      setRemovedItems(classToLoad.removedItems || []);
      setWinner('');
      
      try {
        await window.storage.set('wheel-current-class', classId);
      } catch (error) {
        console.error('Erreur de sauvegarde:', error);
      }
    }
  };

  const addClass = () => {
    if (newClassName.trim()) {
      const newClass = {
        id: Date.now().toString(),
        name: newClassName.trim(),
        items: [],
        removedItems: []
      };
      setClasses([...classes, newClass]);
      setNewClassName('');
      setIsAddingClass(false);
      switchClass(newClass.id);
    }
  };

  const deleteClass = (classId) => {
    if (classes.length <= 1) {
      alert('Vous devez garder au moins une classe');
      return;
    }
    
    const updatedClasses = classes.filter(c => c.id !== classId);
    setClasses(updatedClasses);
    
    if (currentClassId === classId) {
      switchClass(updatedClasses[0].id);
    }
  };

  const renameClass = (classId) => {
    if (editingClassName.trim()) {
      const updatedClasses = classes.map(c =>
        c.id === classId ? { ...c, name: editingClassName.trim() } : c
      );
      setClasses(updatedClasses);
      setEditingClassId(null);
      setEditingClassName('');
    }
  };

  const addItem = () => {
    if (newItem.trim() && items.length < 30) {
      setItems([...items, newItem.trim()]);
      setNewItem('');
    }
  };

  const removeItem = (index) => {
    if (items.length > 1) {
      setItems(items.filter((_, i) => i !== index));
    }
  };

  const resetWheel = () => {
    setItems([...items, ...removedItems]);
    setRemovedItems([]);
    setWinner('');
  };

  const handleFileImport = async (event) => {
    const file = event.target.files?.[0];
    if (!file) return;

    try {
      const text = await file.text();
      let importedItems = [];

      if (file.name.endsWith('.csv')) {
        const lines = text.split('\n').filter(line => line.trim());
        importedItems = lines.map(line => {
          const firstValue = line.split(',')[0].trim();
          return firstValue.replace(/^["']|["']$/g, '');
        }).filter(item => item);
      } else {
        importedItems = text.split('\n')
          .map(line => line.trim())
          .filter(line => line);
      }

      if (importedItems.length > 0) {
        const newItems = [...new Set([...items, ...importedItems])].slice(0, 30);
        setItems(newItems);
      }
    } catch (error) {
      alert('Erreur lors de l\'import du fichier');
      console.error(error);
    }

    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  const handleExport = () => {
    const currentClass = classes.find(c => c.id === currentClassId);
    const allItems = [...items, ...removedItems];
    const text = allItems.join('\n');
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentClass?.name || 'classe'}-prenoms.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const exportAllClasses = () => {
    const dataToExport = {
      version: '1.0',
      exportDate: new Date().toISOString(),
      classes: classes
    };
    const text = JSON.stringify(dataToExport, null, 2);
    const blob = new Blob([text], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `roue-toutes-classes-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const handleImportAllClasses = async (event) => {
    const file = event.target.files?.[0];
    if (!file) return;

    try {
      const text = await file.text();
      const data = JSON.parse(text);
      
      if (data.classes && Array.isArray(data.classes)) {
        const confirmed = window.confirm(
          `Voulez-vous remplacer vos ${classes.length} classe(s) actuelle(s) par les ${data.classes.length} classe(s) du fichier ?\n\nCette action est irr√©versible.`
        );
        
        if (confirmed) {
          setClasses(data.classes);
          const firstClass = data.classes[0];
          setCurrentClassId(firstClass.id);
          setItems(firstClass.items || []);
          setRemovedItems(firstClass.removedItems || []);
          alert(`${data.classes.length} classe(s) import√©e(s) avec succ√®s !`);
        }
      } else {
        alert('Format de fichier invalide');
      }
    } catch (error) {
      alert('Erreur lors de l\'import du fichier');
      console.error(error);
    }

    if (allClassesFileInputRef.current) {
      allClassesFileInputRef.current.value = '';
    }
  };

  const announceWinner = (name) => {
    const utterance = new SpeechSynthesisUtterance(`Et le gagnant est... ${name} !`);
    utterance.lang = 'fr-FR';
    utterance.rate = 0.9;
    utterance.pitch = 1.1;
    window.speechSynthesis.speak(utterance);
  };

  const spinWheel = () => {
    if (isSpinning || items.length === 0) return;
    
    setIsSpinning(true);
    setWinner('');
    
    const minRotations = 10;
    const maxRotations = 15;
    const extraRotations = minRotations + Math.random() * (maxRotations - minRotations);
    const randomDegree = Math.random() * 360;
    const totalRotation = rotation + (extraRotations * 360) + randomDegree;
    
    setRotation(totalRotation);
    
    setTimeout(() => {
      const normalizedRotation = totalRotation % 360;
      const segmentAngle = 360 / items.length;
      const winnerIndex = Math.floor((360 - normalizedRotation) / segmentAngle) % items.length;
      
      const winnerName = items[winnerIndex];
      setWinner(winnerName);
      setIsSpinning(false);
      
      setTimeout(() => {
        announceWinner(winnerName);
        
        setTimeout(() => {
          setRemovedItems(prev => [...prev, winnerName]);
          setItems(prev => prev.filter((_, i) => i !== winnerIndex));
        }, 2500);
      }, 800);
    }, 8000);
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center">
        <div className="text-2xl text-purple-600">Chargement...</div>
      </div>
    );
  }

  const segmentAngle = 360 / items.length;
  const currentClass = classes.find(c => c.id === currentClassId);

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-4">
      <div className="max-w-7xl mx-auto">
        <h1 className="text-4xl font-bold text-center mb-2 text-purple-800">
          üé° Roue de tirage au sort
        </h1>
        <p className="text-center text-sm text-purple-600 mb-4">‚ú® Sauvegarde automatique</p>
        
        {/* S√©lection de classe */}
        <div className="bg-white rounded-lg shadow-md p-4 mb-6 max-w-4xl mx-auto">
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-2">
              <Users className="w-5 h-5 text-purple-600" />
              <h2 className="text-lg font-semibold text-gray-800">Mes classes</h2>
            </div>
            <div className="flex gap-2">
              <input
                ref={allClassesFileInputRef}
                type="file"
                accept=".json"
                onChange={handleImportAllClasses}
                className="hidden"
              />
              <button
                onClick={() => allClassesFileInputRef.current?.click()}
                className="bg-blue-500 text-white px-3 py-1.5 rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2 text-sm"
                title="Importer toutes les classes"
              >
                <Upload className="w-4 h-4" />
                Tout importer
              </button>
              <button
                onClick={exportAllClasses}
                className="bg-green-500 text-white px-3 py-1.5 rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2 text-sm"
                title="Exporter toutes les classes"
              >
                <Download className="w-4 h-4" />
                Tout exporter
              </button>
            </div>
          </div>
          <div className="flex flex-wrap gap-2">
            {classes.map(cls => (
              <div key={cls.id} className="flex items-center gap-1">
                {editingClassId === cls.id ? (
                  <div className="flex items-center gap-1 bg-purple-50 rounded-lg px-2 py-1">
                    <input
                      type="text"
                      value={editingClassName}
                      onChange={(e) => setEditingClassName(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && renameClass(cls.id)}
                      className="px-2 py-1 border border-purple-300 rounded w-32 text-sm"
                      autoFocus
                    />
                    <button onClick={() => renameClass(cls.id)} className="text-green-600 hover:text-green-700">
                      <Check className="w-4 h-4" />
                    </button>
                    <button onClick={() => setEditingClassId(null)} className="text-red-600 hover:text-red-700">
                      <X className="w-4 h-4" />
                    </button>
                  </div>
                ) : (
                  <div className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${
                    currentClassId === cls.id 
                      ? 'bg-purple-600 text-white shadow-md' 
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}>
                    <button
                      onClick={() => switchClass(cls.id)}
                      className="font-medium"
                    >
                      {cls.name}
                    </button>
                    {currentClassId === cls.id && (
                      <>
                        <button
                          onClick={() => {
                            setEditingClassId(cls.id);
                            setEditingClassName(cls.name);
                          }}
                          className="hover:opacity-80"
                        >
                          <Edit2 className="w-4 h-4" />
                        </button>
                        {classes.length > 1 && (
                          <button
                            onClick={() => deleteClass(cls.id)}
                            className="hover:opacity-80"
                          >
                            <X className="w-4 h-4" />
                          </button>
                        )}
                      </>
                    )}
                  </div>
                )}
              </div>
            ))}
            
            {isAddingClass ? (
              <div className="flex items-center gap-1 bg-green-50 rounded-lg px-2 py-1">
                <input
                  type="text"
                  value={newClassName}
                  onChange={(e) => setNewClassName(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && addClass()}
                  placeholder="Nom de la classe"
                  className="px-2 py-1 border border-green-300 rounded w-32 text-sm"
                  autoFocus
                />
                <button onClick={addClass} className="text-green-600 hover:text-green-700">
                  <Check className="w-4 h-4" />
                </button>
                <button onClick={() => setIsAddingClass(false)} className="text-red-600 hover:text-red-700">
                  <X className="w-4 h-4" />
                </button>
              </div>
            ) : (
              <button
                onClick={() => setIsAddingClass(true)}
                className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all flex items-center gap-2"
              >
                <Plus className="w-4 h-4" />
                Nouvelle classe
              </button>
            )}
          </div>
        </div>
        
        <div className="flex gap-6">
          {/* Zone principale - Roue */}
          <div className="flex-1 flex flex-col items-center">
            <div className="relative w-full max-w-2xl aspect-square">
              <div className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-6 z-20 flex flex-col items-center">
                <div className="bg-yellow-400 border-4 border-yellow-600 rounded-full p-3 shadow-lg">
                  <div className="w-0 h-0 border-l-[15px] border-l-transparent border-r-[15px] border-r-transparent border-t-[25px] border-t-yellow-600"></div>
                </div>
              </div>
              
              {items.length > 0 ? (
                <svg
                  ref={wheelRef}
                  className="w-full h-full"
                  style={{ 
                    transform: `rotate(${rotation}deg)`,
                    transition: isSpinning ? 'transform 8s cubic-bezier(0.17, 0.67, 0.12, 0.99)' : 'none'
                  }}
                  viewBox="0 0 200 200"
                >
                  <circle cx="100" cy="100" r="95" fill="#333" />
                  {items.map((item, index) => {
                    const startAngle = (index * segmentAngle - 90) * (Math.PI / 180);
                    const endAngle = ((index + 1) * segmentAngle - 90) * (Math.PI / 180);
                    
                    const x1 = 100 + 95 * Math.cos(startAngle);
                    const y1 = 100 + 95 * Math.sin(startAngle);
                    const x2 = 100 + 95 * Math.cos(endAngle);
                    const y2 = 100 + 95 * Math.sin(endAngle);
                    
                    const largeArc = segmentAngle > 180 ? 1 : 0;
                    
                    const pathData = `M 100 100 L ${x1} ${y1} A 95 95 0 ${largeArc} 1 ${x2} ${y2} Z`;
                    
                    const textAngle = index * segmentAngle + segmentAngle / 2;
                    const textRadius = 65;
                    const textX = 100 + textRadius * Math.cos((textAngle - 90) * Math.PI / 180);
                    const textY = 100 + textRadius * Math.sin((textAngle - 90) * Math.PI / 180);
                    
                    const fontSize = items.length > 15 ? 8 : items.length > 10 ? 10 : 12;
                    const textRotation = textAngle - 90;
                    
                    return (
                      <g key={index}>
                        <path d={pathData} fill={colors[index % colors.length]} stroke="#fff" strokeWidth="2" />
                        <text
                          x={textX}
                          y={textY}
                          fill="white"
                          fontSize={fontSize}
                          fontWeight="bold"
                          textAnchor="middle"
                          dominantBaseline="middle"
                          transform={`rotate(${textRotation}, ${textX}, ${textY})`}
                        >
                          {item.length > 10 ? item.substring(0, 10) + '...' : item}
                        </text>
                      </g>
                    );
                  })}
                  <circle cx="100" cy="100" r="15" fill="#fff" />
                </svg>
              ) : (
                <div className="w-full h-full flex items-center justify-center bg-gray-200 rounded-full">
                  <p className="text-gray-500 text-center px-4 text-xl">Tous les pr√©noms ont √©t√© tir√©s !</p>
                </div>
              )}
            </div>
            
            <div className="flex gap-4 mt-8">
              <button
                onClick={spinWheel}
                disabled={isSpinning || items.length === 0}
                className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-12 py-6 rounded-full font-bold text-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-3"
              >
                <Play className="w-8 h-8" />
                {isSpinning ? 'En cours...' : 'Lancer la roue'}
              </button>
              
              {removedItems.length > 0 && (
                <button
                  onClick={resetWheel}
                  className="bg-blue-500 text-white px-8 py-6 rounded-full font-bold text-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all flex items-center gap-3"
                >
                  <RotateCcw className="w-7 h-7" />
                  R√©initialiser
                </button>
              )}
            </div>
            
            {winner && (
              <div className="mt-8 bg-white p-8 rounded-2xl shadow-2xl text-center animate-bounce">
                <p className="text-gray-600 mb-3 text-xl">üéâ Gagnant :</p>
                <p className="text-5xl font-bold text-purple-600">{winner}</p>
              </div>
            )}
          </div>
          
          {/* Colonne droite - Liste des √©l√©ments */}
          <div className="w-80 bg-white p-6 rounded-lg shadow-lg flex flex-col max-h-screen">
            <h2 className="text-2xl font-bold mb-1 text-gray-800">{currentClass?.name}</h2>
            <p className="text-sm text-gray-500 mb-4">({items.length} √©l√®ves)</p>
            
            <div className="flex gap-2 mb-4">
              <input
                ref={fileInputRef}
                type="file"
                accept=".txt,.csv"
                onChange={handleFileImport}
                className="hidden"
              />
              <button
                onClick={() => fileInputRef.current?.click()}
                className="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center gap-2"
              >
                <Upload className="w-4 h-4" />
                Importer
              </button>
              <button
                onClick={handleExport}
                disabled={items.length === 0 && removedItems.length === 0}
                className="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <Download className="w-4 h-4" />
                Exporter
              </button>
            </div>
            
            <div className="flex gap-2 mb-4">
              <input
                type="text"
                value={newItem}
                onChange={(e) => setNewItem(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && addItem()}
                placeholder="Ajouter un √©l√®ve..."
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                maxLength={20}
              />
              <button
                onClick={addItem}
                disabled={items.length >= 30}
                className="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <Plus className="w-5 h-5" />
              </button>
            </div>
            
            {items.length >= 30 && (
              <p className="text-sm text-orange-600 mb-2">Maximum 30 √©l√®ves</p>
            )}
            
            <div className="space-y-2 overflow-y-auto flex-1 mb-4">
              {items.map((item, index) => (
                <div
                  key={index}
                  className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    <div
                      className="w-4 h-4 rounded-full flex-shrink-0"
                      style={{ backgroundColor: colors[index % colors.length] }}
                    ></div>
                    <span className="font-medium text-gray-700">{item}</span>
                  </div>
                  <button
                    onClick={() => removeItem(index)}
                    disabled={items.length <= 1}
                    className="text-red-500 hover:text-red-700 transition-colors disabled:opacity-30 disabled:cursor-not-allowed flex-shrink-0"
                  >
                    <Trash2 className="w-5 h-5" />
                  </button>
                </div>
              ))}
            </div>
            
            {items.length === 0 && removedItems.length === 0 && (
              <p className="text-sm text-gray-500 mt-2">Ajoutez des √©l√®ves pour commencer</p>
            )}
            
            {removedItems.length > 0 && (
              <div className="pt-4 border-t border-gray-200">
                <h3 className="text-lg font-semibold mb-3 text-gray-700">D√©j√† tir√©s ({removedItems.length})</h3>
                <div className="space-y-2 max-h-48 overflow-y-auto">
                  {removedItems.map((item, index) => (
                    <div
                      key={index}
                      className="flex items-center gap-3 p-2 bg-green-50 rounded-lg"
                    >
                      <span className="text-xl">‚úì</span>
                      <span className="text-gray-600 line-through text-sm">{item}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}